library(dplyr)
library(lme4)
# --- Detect path of current script (works in RStudio interactive mode too) ---
script_dir <- tryCatch({
dirname(rstudioapi::getSourceEditorContext()$path)
}, error = function(e) getwd())
# --- Load helper functions ---
source(file.path(script_dir, "generate_glmm.R"))
source(file.path(script_dir, "generate_glmm_utils.R"))
# =========================================================
# -------------------- USER SETTINGS -----------------------
# List of configurations to run (each element is a list)
configs <- list(
# list(exp = 1, dependentVariable = "risky-rate", model_number = 1),
# list(exp = 2, dependentVariable = "risky-rate", model_number = 2),
# list(exp = 3, dependentVariable = "risky-rate", model_number = 1),
# list(exp = 4, dependentVariable = "optimal-rate", model_number = 1),
# list(exp = 5, dependentVariable = "optimal-rate", model_number = 2),
# list(exp = c(1, 2, 3, 4, 5, 6), dependentVariable = "optimal-rate", model_number = 2),
# list(exp = 7, dependentVariable = "risky-rate", model_number = 3),
#
# list(exp = c(1, 2, 3, 4, 5, 6), dependentVariable = "risky-rate", model_number = 1),
# list(exp = 7, dependentVariable = "risky-rate", model_number = 1)
list(exp = 8, dependentVariable = "risky-rate", model_number = 1) #Exp8 = Erev
)
# =========================================================
# -------------------- MAIN LOOP ---------------------------
for (cfg in configs) {
exp <- cfg$exp
dependentVariable <- cfg$dependentVariable
model_number <- cfg$model_number
erev <- any(exp == 8)
# --- Select data file ---
data_file <- if (erev) "Erev2017_data.csv" else "Nasioulas2024_data.csv"
data_path <- file.path(script_dir, data_file)
cat("\n===============================\n")
cat("Running configuration:\n")
cat("EXP:", exp, "\nDependent Variable:", dependentVariable, "\nModel:", model_number, "\n")
cat("Data file:", data_file, "\n")
# --- Load and subset data ---
myData <- read.csv(data_path)
myData <- subset(myData, EXP %in% exp)
# --- Define formula dynamically ---
formula <- switch(paste0(dependentVariable, "_", model_number),
"risky-rate_1" = choiceRisky ~ 1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY +
(1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"risky-rate_2" = choiceRisky ~ 1 + FEEDBACK * P_RISKY + TRIAL + RISKYBETTER + MAG_RISKY +
(1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"risky-rate_3" = choiceRisky ~ 1 + FEEDBACK * RISKYBETTER + P_RISKY + TRIAL  + MAG_RISKY +
(1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"optimal-rate_1" = choiceCorrect ~ 1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY +
(1 + FEEDBACK + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"optimal-rate_2" = choiceCorrect ~ 1 + FEEDBACK * RISKYBETTER + TRIAL + P_RISKY + MAG_RISKY +
(1 + FEEDBACK + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"repeatRisky_1" = repeatRisky ~ 1 + PREVIOUS_RISKY_POSITIVE + P_RISKY +
(1 + PREVIOUS_RISKY_POSITIVE + P_RISKY | SUBJ),
"repeatRisky_2" = repeatRisky ~ 1 + PREVIOUS_RISKY_POSITIVE * P_RISKY +
(1 + PREVIOUS_RISKY_POSITIVE + P_RISKY | SUBJ),
stop("Invalid dependent variable or model number")
)
# --- Preprocess data & formulas ---
myData$SUBJ <- as.numeric(factor(myData$EXPID))
myData <- myData %>%
rename(
choiceRisky   = RISKY_CHOICE,
choiceCorrect = OPTIMAL_CHOICE,
P_RISKY       = pRisky
)
# --- Conditionally rename MAG_RISKY only if it exists ---
if (!erev && "magRisky" %in% names(myData)) {
myData <- myData %>%
rename(MAG_RISKY = magRisky)
}
if (any(exp %in% 1:6)) {
myData$MAG_RISKY <- ifelse(myData$MAG_RISKY == 60, 1,
ifelse(myData$MAG_RISKY == 40, 0, NA))
} else if (any(exp == 7) && grepl("risky-rate", dependentVariable)) {
# replace RISKYBETTER with VALENCE
formula <- as.formula(gsub("\\bRISKYBETTER\\b", "VALENCE", paste(deparse(formula), collapse = " ")))
# remove TRIAL from random effects structure
formula <- remove_slopes_in_re(formula, group = "SUBJ", drop = "TRIAL")
# MAG_RISKY categorical coding
myData <- myData %>%
mutate(MAG_RISKY = case_when(
MAG_RISKY %in% c(-25, 35) ~ 0,
MAG_RISKY %in% c(-55, 65) ~ 1,
MAG_RISKY %in% c(-85, 95) ~ 2,
TRUE ~ NA_real_
))
} else if (erev) {
# Remove MAG_RISKY as it is not well-defined in Erev
formula <- remove_var_everywhere(formula, vars = "MAG_RISKY")
# Center trial within each feedback condition
myData$TRIAL <- ave(myData$TRIAL, myData$FEEDBACK,
FUN = function(x) as.numeric(scale(x, center = TRUE, scale = TRUE)))
}
#low: probâ‰¤0.25, medium: 0.25<prob<.075, high: probâ‰¥0.75
myData$P_RISKY <- cut(
myData$P_RISKY,
breaks = c(-Inf, 0.25, 0.7499999, Inf),
labels = c(0, 1, 2),
right = TRUE
)
myData$P_RISKY <- as.numeric(as.character(myData$P_RISKY))
# --- Run GLMM model ---
cat("Running GLMM...\n")
model_summary <- generate_glmm(myData, formula, erev = erev)
# --- Display brief summary info ---
cat("\nâœ… Done! Fixed effects:\n")
print(coef(summary(model_summary)))
summary(model_summary)
# --- Create a clean filename based on exp, dependent variable, and model number ---
exp_str <- paste(exp, collapse = "_")  # handles both single number or vector
file_name <- paste0("summary_exp", exp_str, "_", dependentVariable, "_model", model_number, ".txt")
file_path <- file.path(script_dir, file_name)
# --- Capture and save model summary to text file ---
sink(file_path)
cat("===== GLMM Summary =====\n")
cat("Experiment(s):", exp_str, "\n")
cat("Dependent Variable:", dependentVariable, "\n")
cat("Model Number:", model_number, "\n\n")
print(summary(model_summary))
sink()  # always close sink
cat("\nðŸ’¾ Summary saved to:", file_path, "\n")
}
library(dplyr)
library(lme4)
# --- Detect path of current script (works in RStudio interactive mode too) ---
script_dir <- tryCatch({
dirname(rstudioapi::getSourceEditorContext()$path)
}, error = function(e) getwd())
# --- Load helper functions ---
source(file.path(script_dir, "generate_glmm.R"))
source(file.path(script_dir, "generate_glmm_utils.R"))
# =========================================================
# -------------------- USER SETTINGS -----------------------
# List of configurations to run (each element is a list)
configs <- list(
# list(exp = 1, dependentVariable = "risky-rate", model_number = 1),
# list(exp = 2, dependentVariable = "risky-rate", model_number = 2),
# list(exp = 3, dependentVariable = "risky-rate", model_number = 1),
# list(exp = 4, dependentVariable = "optimal-rate", model_number = 1),
# list(exp = 5, dependentVariable = "optimal-rate", model_number = 2),
# list(exp = c(1, 2, 3, 4, 5, 6), dependentVariable = "optimal-rate", model_number = 2),
# list(exp = 7, dependentVariable = "risky-rate", model_number = 3),
#
# list(exp = c(1, 2, 3, 4, 5, 6), dependentVariable = "risky-rate", model_number = 1),
# list(exp = 7, dependentVariable = "risky-rate", model_number = 1)
list(exp = 8, dependentVariable = "risky-rate", model_number = 1) #Exp8 = Erev
)
# =========================================================
# -------------------- MAIN LOOP ---------------------------
for (cfg in configs) {
exp <- cfg$exp
dependentVariable <- cfg$dependentVariable
model_number <- cfg$model_number
erev <- any(exp == 8)
# --- Select data file ---
data_file <- if (erev) "Erev2017_data.csv" else "Nasioulas2024_data.csv"
data_path <- file.path(script_dir, data_file)
cat("\n===============================\n")
cat("Running configuration:\n")
cat("EXP:", exp, "\nDependent Variable:", dependentVariable, "\nModel:", model_number, "\n")
cat("Data file:", data_file, "\n")
# --- Load and subset data ---
myData <- read.csv(data_path)
myData <- subset(myData, EXP %in% exp)
# --- Define formula dynamically ---
formula <- switch(paste0(dependentVariable, "_", model_number),
"risky-rate_1" = choiceRisky ~ 1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY +
(1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"risky-rate_2" = choiceRisky ~ 1 + FEEDBACK * P_RISKY + TRIAL + RISKYBETTER + MAG_RISKY +
(1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"risky-rate_3" = choiceRisky ~ 1 + FEEDBACK * RISKYBETTER + P_RISKY + TRIAL  + MAG_RISKY +
(1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"optimal-rate_1" = choiceCorrect ~ 1 + FEEDBACK + TRIAL + RISKYBETTER + P_RISKY + MAG_RISKY +
(1 + FEEDBACK + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"optimal-rate_2" = choiceCorrect ~ 1 + FEEDBACK * RISKYBETTER + TRIAL + P_RISKY + MAG_RISKY +
(1 + FEEDBACK + RISKYBETTER + P_RISKY + MAG_RISKY | SUBJ),
"repeatRisky_1" = repeatRisky ~ 1 + PREVIOUS_RISKY_POSITIVE + P_RISKY +
(1 + PREVIOUS_RISKY_POSITIVE + P_RISKY | SUBJ),
"repeatRisky_2" = repeatRisky ~ 1 + PREVIOUS_RISKY_POSITIVE * P_RISKY +
(1 + PREVIOUS_RISKY_POSITIVE + P_RISKY | SUBJ),
stop("Invalid dependent variable or model number")
)
# --- Preprocess data & formulas ---
myData$SUBJ <- as.numeric(factor(myData$EXPID))
myData <- myData %>%
rename(
choiceRisky   = RISKY_CHOICE,
choiceCorrect = OPTIMAL_CHOICE,
P_RISKY       = pRisky
)
# --- Conditionally rename MAG_RISKY only if it exists ---
if (!erev && "magRisky" %in% names(myData)) {
myData <- myData %>%
rename(MAG_RISKY = magRisky)
}
if (any(exp %in% 1:6)) {
myData$MAG_RISKY <- ifelse(myData$MAG_RISKY == 60, 1,
ifelse(myData$MAG_RISKY == 40, 0, NA))
} else if (any(exp == 7) && grepl("risky-rate", dependentVariable)) {
# replace RISKYBETTER with VALENCE
formula <- as.formula(gsub("\\bRISKYBETTER\\b", "VALENCE", paste(deparse(formula), collapse = " ")))
# remove TRIAL from random effects structure
formula <- remove_slopes_in_re(formula, group = "SUBJ", drop = "TRIAL")
# MAG_RISKY categorical coding
myData <- myData %>%
mutate(MAG_RISKY = case_when(
MAG_RISKY %in% c(-25, 35) ~ 0,
MAG_RISKY %in% c(-55, 65) ~ 1,
MAG_RISKY %in% c(-85, 95) ~ 2,
TRUE ~ NA_real_
))
} else if (erev) {
# Remove MAG_RISKY as it is not well-defined in Erev
formula <- remove_var_everywhere(formula, vars = "MAG_RISKY")
# Center trial within each feedback condition
myData$TRIAL <- ave(myData$TRIAL, myData$FEEDBACK,
FUN = function(x) as.numeric(scale(x, center = TRUE, scale = TRUE)))
}
#low: probâ‰¤0.25, medium: 0.25<prob<.075, high: probâ‰¥0.75
myData$P_RISKY <- cut(
myData$P_RISKY,
breaks = c(-Inf, 0.25, 0.7499999, Inf),
labels = c(0, 1, 2),
right = TRUE
)
myData$P_RISKY <- as.numeric(as.character(myData$P_RISKY))
# --- Run GLMM model ---
cat("Running GLMM...\n")
model_summary <- generate_glmm(myData, formula, erev = erev)
# --- Display brief summary info ---
cat("\nâœ… Done! Fixed effects:\n")
print(coef(summary(model_summary)))
summary(model_summary)
# --- Create a clean filename based on exp, dependent variable, and model number ---
exp_str <- paste(exp, collapse = "_")  # handles both single number or vector
file_name <- paste0("summary_exp", exp_str, "_", dependentVariable, "_model", model_number, ".txt")
file_path <- file.path(script_dir, file_name)
# --- Capture and save model summary to text file ---
sink(file_path)
cat("===== GLMM Summary =====\n")
cat("Experiment(s):", exp_str, "\n")
cat("Dependent Variable:", dependentVariable, "\n")
cat("Model Number:", model_number, "\n\n")
print(summary(model_summary))
sink()  # always close sink
cat("\nðŸ’¾ Summary saved to:", file_path, "\n")
}
